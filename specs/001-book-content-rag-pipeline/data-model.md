# Data Model: Book Content RAG Pipeline

## Core Entities

### 1. BookPage
**Description**: Represents a single page from the Docusaurus book that has been crawled

**Fields**:
- `url`: string - The full URL of the book page
- `title`: string - The page title extracted from HTML
- `content`: string - Raw HTML content of the page (before cleaning)
- `text_content`: string - Cleaned text content extracted from the page
- `headings`: list of Heading objects - All headings found on the page with their hierarchy
- `created_at`: datetime - Timestamp when the page was crawled
- `status`: enum (SUCCESS, ERROR, SKIPPED) - Status of the crawl operation

**Validation Rules**:
- URL must be a valid HTTPS URL
- Title must not be empty
- Content must be non-empty for successful crawls

### 2. Heading
**Description**: Represents a heading element found on a book page

**Fields**:
- `level`: integer - HTML heading level (1-6)
- `text`: string - Text content of the heading
- `path`: string - Hierarchical path to this heading (e.g., "Chapter 1 > Section A > Subsection 1")
- `position`: integer - Position of the heading in the document

**Validation Rules**:
- Level must be between 1 and 6
- Text must not be empty

### 3. TextChunk
**Description**: A segment of text content that has been chunked according to token limits

**Fields**:
- `chunk_id`: string - Unique identifier for this chunk
- `page_url`: string - URL of the source page
- `heading_path`: string - Hierarchical path of headings for context
- `content_raw`: string - The raw text content of this chunk
- `token_count`: integer - Number of tokens in this chunk
- `overlap_with_previous`: string - Overlapping content with previous chunk (if applicable)
- `overlap_with_next`: string - Overlapping content with next chunk (if applicable)
- `position_in_page`: integer - Position of this chunk in the original page
- `metadata`: dict - Additional metadata for the chunk

**Validation Rules**:
- Token count must be between 300 and 500 tokens
- Content must not be empty
- Chunk ID must be unique across all chunks

### 4. EmbeddingVector
**Description**: A vector representation of a text chunk generated by the embedding model

**Fields**:
- `chunk_id`: string - Reference to the source TextChunk
- `vector`: list of float - The embedding vector (dimension depends on model)
- `model_name`: string - Name of the model used for embedding
- `model_version`: string - Version of the model used
- `created_at`: datetime - Timestamp when the embedding was generated
- `text_chunk`: TextChunk - The original text chunk that was embedded

**Validation Rules**:
- Vector must not be empty
- Model name must be valid (e.g., "embed-english-v3.0")
- Chunk ID must reference an existing TextChunk

### 5. QdrantRecord
**Description**: A record as stored in the Qdrant vector database

**Fields**:
- `id`: string - Unique identifier in Qdrant (same as chunk_id)
- `vector`: list of float - The embedding vector
- `payload`: dict - Metadata stored with the vector in Qdrant
  - `page_url`: string - URL of the source page
  - `heading_path`: string - Hierarchical path of headings
  - `content_raw`: string - The raw text content
  - `chunk_id`: string - Reference to the source chunk
  - `token_count`: integer - Number of tokens in the chunk
  - `position_in_page`: integer - Position in the original page
- `created_at`: datetime - When the record was stored in Qdrant

**Validation Rules**:
- ID must be unique in the collection
- Vector must match the expected dimension for the collection
- Payload must contain all required metadata fields

## Relationships

### BookPage → Heading
- One BookPage contains many Headings (1 to many)
- Each Heading belongs to exactly one BookPage
- Relationship: `book_page.headings` contains list of Heading objects

### BookPage → TextChunk
- One BookPage generates many TextChunks (1 to many)
- Each TextChunk originates from exactly one BookPage
- Relationship: `text_chunk.page_url` references `book_page.url`

### TextChunk → EmbeddingVector
- One TextChunk generates exactly one EmbeddingVector (1 to 1)
- Each EmbeddingVector originates from exactly one TextChunk
- Relationship: `embedding_vector.chunk_id` references `text_chunk.chunk_id`

### EmbeddingVector → QdrantRecord
- One EmbeddingVector becomes one QdrantRecord (1 to 1)
- Each QdrantRecord represents exactly one EmbeddingVector
- Relationship: `qdrant_record.id` equals `embedding_vector.chunk_id`

## State Transitions

### BookPage States
1. `DISCOVERED` - URL found, ready for crawling
2. `CRAWLING` - Currently being crawled
3. `SUCCESS` - Successfully crawled and content extracted
4. `ERROR` - Error occurred during crawling
5. `SKIPPED` - Skipped due to error or filter

### TextChunk States
1. `PENDING` - Chunk created, awaiting processing
2. `EMBEDDING` - Currently being embedded
3. `EMBEDDED` - Embedding generated successfully
4. `FAILED` - Error during embedding process

## Data Flow

```
[BookPage: crawled from URL]
    ↓
[Heading: extracted from page content]
    ↓
[TextChunk: created by chunking page content]
    ↓
[EmbeddingVector: generated from text chunk]
    ↓
[QdrantRecord: stored in vector database]
```

## Validation Rules Summary

1. **Completeness**: All required fields must be present
2. **Integrity**: Foreign key relationships must be valid
3. **Constraints**: Token counts and vector dimensions must meet specifications
4. **Uniqueness**: IDs must be unique within their context
5. **Format**: URLs, timestamps, and other formatted fields must be valid