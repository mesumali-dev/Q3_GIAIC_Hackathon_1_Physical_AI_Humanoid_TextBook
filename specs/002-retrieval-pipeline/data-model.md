# Data Model: Retrieval Pipeline

## Overview
This document defines the data structures and relationships for the retrieval pipeline feature that queries the Qdrant vector database using semantic similarity search.

## Entities

### Query
**Description**: A natural language input that needs to be converted to embeddings and used for semantic search
**Fields**:
- `text`: string - The raw natural language query text
- `embedding`: list[float] - The vector representation of the query text
- `filters`: dict - Optional metadata filters (e.g., by URL or section)
- `top_k`: int - Number of results to retrieve (default: 3-5)

### Vector Embedding
**Description**: Numerical representation of text content generated by the Cohere model for similarity matching
**Fields**:
- `vector`: list[float] - The actual embedding vector
- `model`: string - The model used to generate the embedding
- `size`: int - The dimensionality of the embedding vector

### Content Chunk
**Description**: A segment of book content with associated metadata stored in Qdrant
**Fields**:
- `id`: string - Unique identifier for the chunk
- `text`: string - The original text content of the chunk
- `url`: string - Source URL where the content originated
- `section_hierarchy`: list[string] - Hierarchical path of sections/headers
- `chunk_id`: string - Identifier for the specific chunk within the document
- `position`: int - Position order within the original document

### Retrieval Result
**Description**: The top-K semantically relevant content chunks returned in response to a query with associated scores
**Fields**:
- `query`: Query - The original query that generated this result
- `chunks`: list[Content Chunk] - The retrieved content chunks
- `scores`: list[float] - Similarity scores for each chunk
- `retrieval_time_ms`: float - Time taken to retrieve the results
- `total_results`: int - Total number of results found before top-K filtering

### Metadata Filter
**Description**: Criteria used to narrow search results by specific attributes like page URL or section
**Fields**:
- `field`: string - The field to filter on (e.g., "url", "section_hierarchy")
- `value`: string - The value to match
- `operator`: string - The comparison operator (e.g., "equals", "contains")

## Relationships

### Query → Retrieval Result
- One Query generates one Retrieval Result
- Cardinality: 1:1 (each query execution produces one result set)

### Retrieval Result → Content Chunk
- One Retrieval Result contains multiple Content Chunks
- Cardinality: 1:K (where K is the top-K parameter)

### Content Chunk → Vector Embedding
- Each Content Chunk has one associated Vector Embedding (for storage in Qdrant)
- Cardinality: 1:1

## Validation Rules

### Query Validation
- `text` must not be empty or only whitespace
- `top_k` must be a positive integer (1-100 range)
- `filters` must have valid field names and values

### Content Chunk Validation
- `text` must not be empty
- `url` must be a valid URL format
- `id` must be unique within the system

### Retrieval Result Validation
- `chunks` list must not exceed `top_k` count
- `scores` must be between 0 and 1 (similarity scores)
- `retrieval_time_ms` must be positive

## State Transitions

### Query Processing Flow
1. **Input**: Query object created with text and parameters
2. **Embedding**: Query.text converted to embedding vector
3. **Search**: Vector used to search Qdrant collection
4. **Filter**: Results filtered by metadata if specified
5. **Format**: Results formatted with metadata reconstruction
6. **Output**: Retrieval Result returned with chunks and metrics

## Data Formats

### JSON Schema for Query
```json
{
  "type": "object",
  "properties": {
    "text": {"type": "string"},
    "top_k": {"type": "integer", "minimum": 1, "maximum": 100},
    "filters": {"type": "object"}
  },
  "required": ["text"]
}
```

### JSON Schema for Retrieval Result
```json
{
  "type": "object",
  "properties": {
    "query": {"$ref": "#/definitions/Query"},
    "chunks": {
      "type": "array",
      "items": {"$ref": "#/definitions/ContentChunk"}
    },
    "scores": {
      "type": "array",
      "items": {"type": "number", "minimum": 0, "maximum": 1}
    },
    "retrieval_time_ms": {"type": "number"},
    "total_results": {"type": "integer"}
  },
  "required": ["chunks", "scores", "retrieval_time_ms"]
}
```